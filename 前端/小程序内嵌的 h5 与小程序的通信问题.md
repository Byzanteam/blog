# 小程序内嵌的 h5 与小程序的通信问题

## 项目背景

小程序内嵌的 H5 页面需要跳转到小程序页面

## 解决方案

1. 引入<https://res.wx.qq.com/open/js/jweixin-1.6.0.js>脚本文件
2. 在 TypeScript 文件中声明 wx 全局变量
   * 使用`declare`关键字声明了`wx`全局变量。这将告诉TypeScript编译器这个变量已经存在，可以在其他地方使用。由于`wx`对象是一个第三方库提供的全局变量，我们无法使用类型声明文件来描述其类型，因此我们将其类型声明为`any`。
3. 使用实例

   ```html
    <template>
      <div>
        <button @click="changeUser">changeUser</button>
      </div>
    </template>
    <script lang="ts">
      import { defineComponent } from 'vue';
      export default defineComponent({
        setup() {
          function changeUser() {
            if (typeof wx !== undefined) {
              wx.miniProgram.navigateTo({ url: "/pages/mobile/view/index" });
              }
            }
          return {
            changeUser
          }
        }
      });
    </script>
   ```

## 通信问题解决方案

### 通信方案一：wx.miniProgram.xxx

1. 可调用的 API 有限
2. 将简单的能力集成在 h5 页面中
3. eg 如上述
4. 优点：
   1. wx.miniProgram.xxx 方法可以方便地实现在H5页面中调用小程序提供的API，如分享、支付等，增加了H5页面的功能性。
   2. wx.miniProgram.xxx 方法在使用过程中不需要进行微信公众号认证等复杂的配置，相对较为简单。
   3. wx.miniProgram.xxx 方法的调用效率相对较高，因为小程序和H5页面都是在微信客户端中运行的，所以可以直接进行通信，不需要像wx.postMessage 方法那样通过中转服务器进行通信。
5. 缺点：
   1. 在H5页面中直接使用 wx.miniProgram.xxx 方法需要用户已经安装了对应的小程序，否则将无法执行。
   2. 由于小程序和H5页面之间的通信是在微信客户端中进行的，所以可能会受到微信客户端版本的限制，需要进行兼容性测试。

### 通信方案二：wx.postMessage({xxx:xxx})

* eg:

  在HTML页面中，可以使用以下代码发送消息

  ```html
    <button onclick="sendMessage()">发送消息</button>

    <script>
    function sendMessage() {
      var message = {
        type: 'hello',
        data: '这是一条消息'
      };
      window.parent.postMessage(message, '*');
    }
    </script>
    <!-- 当用户点击“发送消息”按钮时，将创建一个包含类型为“hello”和数据为“这是一条消息”的消息对象。然后，使用window.parent.postMessage方法将消息发送到父窗口，即微信web-view -->
  ```

  在微信web-view中，可以使用以下代码接收消息

  ```ts
    wx.onMessage(function(message) {
      if (message.type === 'hello') {
        console.log(message.data);
      }
    })
    // 当微信web-view收到一个消息时，它将检查消息的类型是否为“hello”。如果是，则将消息的数据打印到控制台中
    // 这个示例假定您已经在微信中加载了一个包含上述HTML代码的web-view，并且已经使用wx.ready方法初始化了微信JS-SDK
  ```

1. 将信息发送给小程序，由小程序内部监听信息，监听到信息后由小程序主动做出响应，能力集成在小程序端

2. 优势：
   1. 实现了 web-view 和父窗口之间的通信，可以方便地在微信中进行网页应用的开发
   2. 可以使用微信JS-SDK中提供的一些API，如分享、支付等
3. 缺点：
   1. 使用 wx.postMessage 方法需要进行一些复杂的配置，需要在微信公众号中进行认证等操作。
   2. web-view 的性能不如原生应用，可能会出现卡顿等问题。
   3. 需要考虑H5页面和小程序之间的安全性问题，需要进行一些安全措施。
   4. wx.postMessage 方法可能会增加H5页面的加载时间，影响用户体验。

## 知识不迷路

1. web-view（非组件容器） 承载网页的容器。会自动铺满整个小程序页面
2. 小程序在调试模式，在右上角的 “详情” 中 “本地设置” 钩上 “不校验合法域名、web-view（业务域名）、TLS版本以及HTTPS证书
3. web-view 网页与小程序之间不支持除 JSSDK 提供的接口之外的通信
4. 网页内 iframe 的域名也需要配置到域名白名单

## 相关文档

* web-view文档：<https://developers.weixin.qq.com/miniprogram/dev/component/web-view.html>
* 拓展：第三方静态网站 H5 跳转小程序：<https://developers.weixin.qq.com/miniprogram/dev/wxcloud/guide/staticstorage/jump-miniprogram.html>
